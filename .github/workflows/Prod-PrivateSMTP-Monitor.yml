# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Prod PrivateSMTP Monitor

on:
  workflow_dispatch:

jobs:
  prodprivatesmtp:
    runs-on: ubuntu-latest  
    strategy:
      fail-fast: false
      matrix:
        node-version: [14.x]
        collection: [ All_Esps_Welcome_Mail_SystemField_DateFunction_OcxNow_Offset_1,All_ESPs_AB_Split_Feed_Operator_OcxNow_1,All_ESPs_AB_Split_FeedRSS_Dynamic_Feed_All_Field_Function_1,All_Esps_AB_Winner_Dynamic_Ocx_feed,All_Esps_AB_Winner_Using_Message_Open_System_field-List_Field_Date_Function,All_ESPs_Event,All_Esps_Notify_Transactional_Content_HTML_Dynamic_HTML_Feeds,ALL_Esps_Notify_Transactional_Message_Id_Behaviour_Stats_13230,ALL_Esps_Notify_Transactional_Content_HTML_Behaviour_Stats_13230,All_Esps_Notify_Transactional_Message_Id_Dynamic_HTML_Feeds,All_Esps_Notify_Transactional_Message_Id_SystemField_DateFunction_OcxNow_Offset,All_Esps_Notify_Transactional_Content_HTML_SystemField_DateFunction_OcxNow_Offset,ALL_Esps_Regular_Campaign_Behaviour_Stats_13230,All_Esps_Regular_Campaign_Message_Id_Dynamic_HTML_Feeds,All_Esps_Regular_Campaign_Message_Id_SystemField_And_Ocx_Now,All_Esps_Transactional-Send_Content_HTML_Dynamic_HTML_Feeds,All_Esps_Transactional_Send_Content_HTML_SystemField_DateFunction_OcxNow_Offset,All_Esps_Transactional-Send_Message_Id_Dynamic_HTML_Feeds,All_Esps_Transactional_Send_Message_Id_SystemField_DateFunction_OcxNow_Offset,ALL_Esps_Transactional_Send_Content_HTML_Behaviour_Stats_13230,ALL_Esps_Transactional_Send_Message_Id_Behaviour_Stats_13230,All-Esps-AR-Test-Cases,All_Esps_Campaign_Test_Mail_1,All_Esp_Event_Based_On_List,All_Esps_Campaign_Mirror_Test_2,All_Esps_AB_Split_Campaign_With_Subject_1,All_Esps_AB_Split_With_Multiple_esp_1,All_Esp_Event_Campaign_Open_Click,All_ESP_Regular_Campaign_Multiple_esp_1,All_Esps_AB_Winner_Using_Esps_Number_Open,All_Esp_And_Segment_Level_Distribution_1,All_Esps_Esp_Domin_Test_1,All_ESP_Campaign_with_Conversion_Pixel_links,Verify_Get_URL_Conversion_point,All_Esps_AB_Split_One_Minute_Throttling_1,All_Esps_AB_Split_Throttling_1,All_Esps_AB_Split_Throttling_Date_Field_1,All_Esps_Event_Based_Throttling_1,All_Esps_Notify_Transactional_Using_HTML_Regular_Suppression,All_Esps_Event_Based_Throttling_Date_Field_1,All_Esps_Event_Based_Throttling_One_Minute_1,All_Esps_Regular_Campaign_Date_Field_Throttling_1,All_Esps_Regular_Campaign_One_Minute_Throttling_1,All_Esps_Regular_Campaign_Throttling_1,All_Esps_Notify_Transactional_Using_Email_Regular_Suppression,All_Esps_Notify_Transactional_Send_Embed_Content_Regular_Suppression,All_Esps_Transactional_Send_Regular_Suppression,All_Esps_RC_Send_Regular_Suppression_Email,All_ESP_NT_Content_HTML_With_domain_Suppression,All_ESP_NT_Send_Email_With_domain_Suppression,All_ESP_TC_Send_Embed_Content_With_domain_Suppression,All_ESP_TC_Send_With_domain_Suppression,All_Esps_RC_Send_Domain_Suppression_Email,All_ESP_NT_Content_HTML_With_md5_Suppression,All_ESP_NT_Send_Email_With_md5_Suppression,All_ESP_TC_Send_Embed_Content_With_md5_Suppression,All_Esps_RC_Send_md5_Suppression_Email,All_ESP_TC_Send_With_md5_Suppression,All_ESP_TC_Send_Embed_Content_With_SHA512_Suppression,All_ESP_NT_Content_HTML_With_SHA512_Suppression,All_ESP_NT_Send_Email_With_SHA512_Suppression,All_ESP_TC_Send_With_SHA512_Suppression,All_Esps_RC_Send_SHA_512_Suppression_Email,All_Esps_RC_Send_SHA_256_Suppression_Email,All_Esps_Notify_Transactional_Using_Email_SHA256,All_ESP_TC_Send_With_SHA256_Suppression,All_ESP_TC_Send_Embed_Content_With_SHA256_Suppression,All_ESP_NT_Content_HTML_With_SHA256_Suppression,All_Esps_AB_Split_With_Multiple_esp_And_Message,All_Esps_AB_Split_With_Quota,All_Esps_AB_Split_Mirror_Test,All_Esps_AB_Split_With_Custom_Split_Message,All_Esps_AB_Split_With_Custom_Split_Subject,All_Esps_AB_Split_With_Custom_Split_Esp,All_Esp_Event_With_Multiple_Trigger,All_Esps_AB_Split_With_Multi_Esp_Message_with_number,All_Esps_AB_Split_With_Multi_Esp_Subject_with_number,All_Esps_Event_With_Campaign_Quota,All_Esps_Email_Message_Create_Update_Delete,All_Esps_Welcome_Email_With_Secound_Mail,All_Esp_Event_Trigger_With_Trigger,All_Esps_Regular_Campaign_Delete_Segment,All_Esps_Campaign_Timezone_With_Timestamp,All_Esp_Event_With_Timestamp,All_Esps_Campaign_Timezone_With_IP,All_Esps_Campaign_Timezone_With_Airport_Code,All_Esps_Campaign_Timezone_With_Zipcode,ALL_Esps_RC_List_Unsubscribe_Header,All_Esps_Regular_Campaign_Tracking_Domain,All_Esps_Regular_Campaign_With_Segment_Quota_Limit,All_Esps_Transactional_Campaign_With_Msg_Id_Ocx_If_Else_Multiple,All_Esps_Transactional_Campaign_With_Html_Ocx_If_Else_Multiple,All_Esps_Notify_Transaction_With_Html_Ocx_If_Else_Multiple,All_Esps_Notify_Transaction_With_Msg_Id_Ocx_If_Else_Multiple,All_Esps_Notify_Transaction_With_Msg_Id_Ocx_If_Else,All_Esps_Notify_Transaction_With_Html_Ocx_If_Else,All_Esps_Transactional_Campaign_With_Msg_Id_Ocx_If_Else,All_Esps_Transactional_Campaign_With_Html_Ocx_If_Else,All_Esps_Regular_Campaign_If_Else_Multiple,All_Esps_Regular_Campaign_If_Else,All_ESP_Regular_Campaign_Multiple_esp_With_Limit_quota_Precantge,All_ESP_Regular_Campaign_Multiple_esp_With_Limit_quota_number,All_Esps_Campaign_Ocx_Dynnamic_Feed_inside_ocx_loop,All_Esps_Notify_Transactional_Send_Msg_Id_Ocx_Dynamic_Feed_inside_ocx_loop,All_Esps_Notify_Transactional_Content_Html_Ocx_Dynamic_Feed_inside_ocx_loop,All_Esps_Transactional_Send_Embed_Content_Ocx_Dynamic_Feed_inside_ocx_loop,All_Esps_Transactional_Send_Msg_Id_Ocx_Dynamic_Feed_inside_ocx_loop,All_Esps_NT_Html_Ocx_If_Else_Nested,All_Esps_NT_Msg_Id_Ocx_If_Else_Nested,All_Esps_RC_Ocx_If_Else_Nested,All_Esps_TC_Html_Ocx_If_Else_Nested,All_Esps_TC_Msg_Id_Ocx_If_Else_Nested,All_Esps_AB_Split_With_Nested_ocx_If,All_Esps_Event_Ocx_If_Else_Nested,All_Esps_Welcome_Msg_With_Nested_If,All_Esps_AB_Winner_With_Nested_ocx_If,All_Esps_RC_With_Multiple_Ocx_If_Blocks,All_Esps_Notify_Transactional_Content_Html_Asp_8720,All_Esps_Notify_Transactional_Msg_Id_Asp_8720,All_Esps_Transactional_Msg_Id_Asp_8720,All_Esps_Transactional_Send_Embed_Content_Asp_8720,All_Esps_RC_Return_Path_Header,All_Esps_AB_Winner_Using_Esps_Number_Open_1,All_Esp_Event_With_Phoenix_Timestamp,All_Esps_Regular_Campaign_Timezone_Phoenix_Timestamp,All_Esps_AB_Split_Campaign_Phoenix_Timezone,All_Esps_RC_Dynamic_From_Name_Test,All_Esps_Notify_Transactional_Content_Html_Dynamic_From_Name_Test,All_Esps_Notify_Transactional_Msg_Id_Dynamic_From_Name_Test,All_Esps_Transactional_Send_Dynamic_From_Name_Test,All_Esps_Transactional_Send_Embed_Content_Dynamic_From_Name_Test,RC_Send_Suppression_Expiry_Next_Day,RC_Send_Suppression_Expiry_Date,All_Esps_Notify_transactional_With_Html_Post_Back_Link,All_Esps_Notify_transactional_With_Msg_Id_Post_Back_Link,All_Esps_Regular_Campaign_Post_Back_Link,All_Esps_TC_Send_Embed_With_Post_Back_Link,All_Esps_TC_Send_With_Post_Back_Link,All_Esp_Event_With_Post_Back_Link,All_Esps_Validations_Test_STO_MVP,All_Esps_RC_Test_STO_MVP,Verify_Suppression_List_Total_Size_Count,Verify_API_call_for_export_csv_with_link,Verify_super_user_getting_list_fields,Verify_Empty_Result_For_Report,All_ESP_Event_Internal_db_Error,Verify_report_not_generated_with_deleted_campaign,All_Esp_Regular_Campaign_with_quota_value,Verify_contact_search_report_without_defining_limit,AB_winner_using_message_with_unique_open,AB_split_campaign_with_throttling,AB_split_campaign_using_quota_with_throttling,AB_split_campaign_using_custom_ratio_with_throttling,Verify_matrix_report_in_export_for_Domain_Grouped_by_ESP,Verify_Matrix_Report_using_ESP_Grouped_by_Domain,All_Esp_Regular_Campaign_with_quota_value_test_inhouse_mode,AB_split_campaign_Throttling_and_Real_time_AB_Test_Working_Simultaneously,RC_list_field_update_On_click,NT_content_html_list_field_update_On_click,NT_message_id_list_field_update_On_click,Transactional_send_list_field_update_On_click,Transactional_send_embed_content_field_update_On_click,RC_list_field_with_update_On_click,TC_send_list_field_with_update_On_click,TC_send_embed_content_field_update_with_On_click,NT_content_html_list_field_with_update_On_click,NT_message_id_list_field_with(-)_update_On_click,RC_unsubscribe_text_double_link_dynamic_ocx_feed,TC_send_unsubscribe_text_double_link_dynamic_ocx_feed,TC_send_embed_content_unsubscribe_text_double_link_dynamic_ocx_feed,NT_message_id_unsubscribe_text_double_link_dynamic_ocx_feed,NT_content_html_unsubscribe_text_double_link_dynamic_ocx_feed,NT_content_html_list_field_update_on_clicked_multiple_link_ocxfa,NT_message_id_list_field_update_on_clicked_multiple_link_ocxfa,RC_list_field_update_on_clicked_multiple_link_ocxfa,TC_send_embed_content_list_field_update_on_clicked_multiple_link_ocxfa,TC_send_list_field_update_on_clicked_multiple_link_ocxfa,Test_last_modified_date_update_for_custom_aggregate_report,Verify_RC_If-Then-Else_Rules_is_working_in_dynamic_html_feed,Verify_NT_content_html_If-Then-Else_Rules_is_working_in_dynamic_html_feed,Verify_NT_message_id_If-Then-Else_Rules_is_working_in_dynamic_html_feed,Verify_TC_send_If-Then-Else_Rules_is_working_in_dynamic_html_feed,TC_Verify_If_Then_Else_Rules_in_dynamic_html_feed,Verify_Regular_campaign_trottling_without_timezone,Add_system_field_for_contacts_last_modified_date,Verify_RC_while_using_underscore_containing_string_contact_field,Verify_login_generate_new_jwt_token,Validation_username_password_post_api_login,Create_email_with_generated_token_and_username_password,Get_all_segments_with_generated_token_and_username_password,Create_email_with_expired_token_and_username_password,Update_contact_with_expired_token_and_username_password,Verify_blank_page_response_on_Unsubscribe_link_of_account_level,Verify_regular_suppression_list_level_breakdown_functionality_using_list_scope_with_RC,Verify_regular_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_split_campaign,Verify_regular_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_winner_campaign,Verify_md5_suppression_list_level_breakdown_functionality_using_list_scope_with_RC,Verify_md5_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_split_campaign,Verify_md5_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_winner_campaign,Verify_sha_256_suppression_list_level_breakdown_functionality_using_list_scope_with_RC,Verify_sha_256_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_winner_campaign,Verify_sha_512_suppression_list_level_breakdown_functionality_using_list_scope_with_RC,Verify_sha_512_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_split_campaign,Verify_md5_suppression_list_level_breakdown_functionality_using_globals_scope_with_RC,Verify_sha512_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_winner_campaign,Verify_sha256_suppression_list_level_breakdown_functionality_using_list_scope_with_ab_split_campaign,Verify_blank_page_response_on_Unsubscribe_link_of_list_level,Verify_suppression_list_breakdown_functionality_with_regular_campaign_using_global_level_scope,Verify_suppression_list_breakdown_functionality_with_AB_split_campaign_using_global_level_scope,Verify_regular_suppression_list_breakdown_functionality_using_global_scope_with_ab_winner_campaign,Verify_md5_suppression_breakdown_functionality_using_global_scope_with_ab_split_campaign,Verify_md5_suppression_breakdown_functionality_using_global_scope_with_ab_winner_campaign,Verify_sha_256_suppression_breakdown_functionality_using_global_scope_with_RC,Verify_sha256_suppression_breakdown_functionality_using_global_scope_with_ab_split_campaign,Verify_sha512_suppression_list_breakdown_with_regular_campaign_using_global_level_scope,Verify_sha_512_suppression_global_level_breakdown_functionality_using_global_scope_with_ab_split_campaign,Verify_sha512_suppression_breakdown_functionality_using_global_scope_with_ab_winner_campaign,Verify_regular_suppression_campaign_level_breakdown_functionality_using_campaign_scope_with_RC,Verify_regular_suppression_list_level_breakdown_functionality_using_campaign_scope_with_ab_split_campaign,Verify_suppression_regular_list_breakdown_functionality_using_campaign_level_with_ab_winner_campaign,Verify_md5_suppression_list_level_breakdown_functionality_using_campaign_scope_with_RC,Verify_md5_suppression_breakdown_functionality_using_campaign_level_with_ab_split_campaign,Verify_sha256_suppression_campaign_level_breakdown_functionality_using_campaign_scope_with_ab_split_campaign,Verify_sha_256_suppression_campaign_level_breakdown_functionality_using_campaign_scope_with_ab_winner_campaign,Verify_sha256_suppression_campaign_level_breakdown_functionality_using_campaign_scope_with_RC,Verify_sha_512_suppression_Campaign_level_breakdown_functionality_using_campaign_scope_with_RC,Verify_sha_512_suppression_campaign_level_breakdown_functionality_using_campaign_scope_with_ab_split_campaign,Verify_sha512_suppression_breakdown_functionality_using_campaign_scope_with_ab_winner_campaign,Verify_Notify_Transactional_campaign_with_content_html_using_specific_message,Verify_transactional_send_campaign_with_specific_message,Verify_notify_transactional_campaign_with_embeded_html_using_specific_message,Verify_transactional_campaign_with_send_embed_content_for_specific_message,Verify_negative_decimal_values_using_segment_and_contact_manager_report,Verify_RC_link_with_contact_activity_report,Verify_md5_suppression_breakdown_functionality_using_campaign_level_with_ab_winner_campaign,Verify_minimum_allowed_decimal_value_for_numeric_in_segment,Verify_maximum_allowed_&_decimal_value_for_numeric_in_segment,Verify_Event_Campaign_and_contact_activity_report_with_one_link_included_in_the_email_content,Verify_import_contact_with_default_value_of_list_field_empty_using_regular_list,Verify_the_decimal_values_with_grouping_separators,Verify_send_empty_content_flag_true_for_dynamic_content_with_ab_split_campaign,Verify_send_error_content_flag_true_for_dynamic_content_with_ab_split_campaign,vr_ab_winner_error_content_flag_True_for_dynamic_content,Verify_AB_Winner_empty_content_flag_True_for_dynamic_content_200 ]
    steps:
    - uses: actions/checkout@v3.3.0
    - name: Prod PrivateSMTP Monitor collections
      uses: actions/setup-node@v3.6.0
      with:
        node-version: ${{ matrix.node-version }}
        
    # Install the newman command-line utility, also install the html extra reporter
    - name: Install newman and newman-reporter-htmlextra and artifact
      run: |
        npm install -g newman
        npm install -g newman-reporter-htmlextra
        npm install install-artifact-from-github
    
    - name: Run ${{ matrix.collection }}
      id: first_run
      run: newman run ./node/Campaigns/${{ matrix.collection }}.json -e ./node/Campaigns/Env/all-esps-production-10998.json -g ./node/Campaigns/Env/prod-privatesmtp-monitor-global-env.json --reporters cli,htmlextra --reporter-htmlextra-export ./newman/prod-privatesmtp-"${{ matrix.collection }}"-report.html      
        
    - name: Retry ${{ matrix.collection }}
      if: ${{ failure() }}
      run: newman run ./node/Campaigns/${{ matrix.collection }}.json -e ./node/Campaigns/Env/all-esps-production-10998.json -g ./node/Campaigns/Env/prod-privatesmtp-monitor-global-env.json --reporters cli,htmlextra --reporter-htmlextra-export ./newman/prod-privatesmtp-"${{ matrix.collection }}"-retrying-report.html
      continue-on-error: true
    
    # Upload the contents of test results directory to workspace
    - name: Output prod PrivateSMTP monitor collection
      uses: actions/upload-artifact@v3
      with:
          name: prod-privatesmtp-monitor-report
          path: newman